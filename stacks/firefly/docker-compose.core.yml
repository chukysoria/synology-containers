services:
  app:
    image: fireflyiii/core:version-6.2.4@sha256:458c2a97f4711a71d84ed1c6521e3f535446af9501fe29374cb159d265eee22f
    hostname: app
    container_name: firefly_iii_core
    networks:
      - firefly-net
      - firefly-net-frontend
      - firefly-db-net
    restart: always
    env_file:
      - ../../stack.env
    volumes:
      - firefly_iii_upload:/var/www/html/storage/upload
    labels:
      traefik.enable: true
      traefik.docker.network: firefly-net-frontend
      traefik.http.routers.fireflyiii-rtr.rule: Host(`firefly.${DOMAIN:-boulebar.duckdns.org}`)
      traefik.http.routers.fireflyiii-rtr.middlewares: authentik@docker

  fftc:
    image: akopulko/ffiiitc:latest@sha256:453f55acb45089614ea77c5480596c71c053f8f3b1a98ec467f9a151675d59d0
    hostname: fftc
    networks:
      - firefly-net
    restart: always
    container_name: ffiiitc
    environment:
      - FF_APP_URL=http://app:8080
      - FF_API_KEY=${FF_API_KEY:?Firefly III API Key}
    volumes:
      - ffiiitc-data:/app/data
    depends_on:
      - app

  firefly-pico:
    image: cioraneanu/firefly-pico:1.6.0@sha256:b2f93cc61cb0de35d748e56c8ad9e9cc28eb6a3f23766b5e6b5aa9bd3f5e9de3
    container_name: firefly_pico
    environment:
      - FIREFLY_URL=http://app:8080
      - DB_CONNECTION=pgsql
      - DB_HOST=timescaledb
      - DB_PORT=5432
      - DB_DATABASE=firefly-pico
      - DB_USERNAME=firefly-pico
      - DB_PASSWORD=${PG_PICO_PASS:?Firefly Pico DB Password}
      - TZ=${TZ:-Europe/Madrid}
    networks:
      - firefly-net
      - firefly-net-frontend
      - firefly-db-net
    depends_on:
      - app
    labels:
      traefik.enable: true
      traefik.docker.network: firefly-net-frontend
      traefik.http.routers.firefly-pico-rtr.rule: Host(`ffpico.${DOMAIN:-boulebar.duckdns.org}`)
      traefik.http.services.firefly-pico-svc.loadbalancer.server.port: 80

  cron:
    image: ghcr.io/chukysoria/baseimage-alpine:v0.7.6-3.21
    networks:
      - firefly-net
    restart: unless-stopped
    environment:
      # General LinuxServer.io
      PUID: ${PUID:-1029}
      PGID: ${PGID:-65536}
      TZ: ${TZ:-Europe/Madrid}
      DOCKER_MODS: "linuxserver/mods:universal-cron"
    volumes:
      - ${BASE_PATH:-/volume2/docker/}firefly/cron:/config/crontabs:ro

volumes:
   firefly_iii_upload:
   ffiiitc-data:

networks:
  firefly-net:
    name: firefly-net
    driver: bridge
  firefly-net-frontend:
    external: true # Defined in traefik
  firefly-db-net:
    external: true # Defined in databases
